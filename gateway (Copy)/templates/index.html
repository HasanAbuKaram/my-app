<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlastBau E-SupplyChain Platform</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
</head>
<body>
    <!-- Hero Section for Introduction -->
    <section class="hero is-primary is-medium">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">
                    Welcome to PlastBau E-SupplyChain Platform
                </h1>
            </div>
        </div>
    </section>

    <!-- Main Content Section with Cards -->
    <section class="section">
        <div class="container">
            <div class="columns is-multiline">

                <!-- Card 1: Submit Quotations -->
                <div class="column is-one-quarter">
                    <div class="card" id="quotation">
                        <div class="card-content">
                            <p class="title">Quotations</p>
                            <p class="subtitle">..</p>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Submit Invoices -->
                <div class="column is-one-quarter">
                    <div class="card" id="invoice">
                        <div class="card-content">
                            <p class="title">Invoices</p>
                            <p class="subtitle">..</p>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Vendor Registration -->
                <div class="column is-one-quarter">
                    <div class="card" id="newVendor">
                        <div class="card-content">
                            <p class="title">Registration</p>
                            <p class="subtitle">..</p>
                        </div>
                    </div>
                </div>

                <!-- Card 4: PlastBau Team 
                <div class="column is-one-quarter">
                    <a href="#plastbauteam" class="card" id="plastbauteamButton">
                        <div class="card-content has-text-centered">
                            <p class="title">PlastBau Team</p>
                        </div>
                    </a>
                </div>
                -->
                <div class="column is-one-quarter">
                    <div class="card" id="plastbauteamButton">
                        <div class="card-content">
                            <p class="title">PlastBau Team</p>
                            <p class="subtitle">..</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>PlastBau E-SupplyChain Platform</strong> by <a href="https://plastbauarabia.com">PlastBau Arabia</a>.
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script type="module">
        import { initializeMSAL, myMSALObj, name } from '/common/templates/common.js';

        initializeMSAL();
        // Now you can access `myMSALObj` in other parts of your app
        console.log(myMSALObj); // It will be available after initializeMSAL is called
       // document.querySelector("#message").innerHTML += "Hello, ! " + name + "!";
       // document.querySelector("#logoutButton").classList.remove("is-hidden");

        document.querySelector("#plastbauteamButton").addEventListener("click", async function(event) {
            // Prevent the default anchor behavior (optional)
            event.preventDefault();

            // Clear the session storage item
            sessionStorage.removeItem("msal.interaction.status");

        // Initialize MSAL.js
        const msalConfig = {
                auth: {
                    clientId: "1c412488-b824-49c3-aa63-af78a0743b26", // replace with your app client id
                    authority: "https://login.microsoftonline.com/d33520e6-0dd4-4718-b1df-356beb84e0c5", // replace with your tenant id
            //        redirectUri: window.location.href, // current page
                },
                cache: {
                    cacheLocation: "localStorage",
                    storeAuthStateInCookie: false,
                }
            };

            const myMSALObj = new msal.PublicClientApplication(msalConfig);

            // Check login status on page load
            const accounts = myMSALObj.getAllAccounts();
            if (accounts.length > 0) {
                // User is logged in
              //  alert("Hello, " + accounts[0].name + "!") ;
                window.location.replace("http://localhost:8080/"); 
            } 

            // Redirect to the PlastBau team page or any desired URL
            myMSALObj.loginPopup()
                .then(response => {
                    alert("Hello, " + response.account.name + "!");
                    
                    myMSALObj.setActiveAccount(response.account);

                    myMSALObj.acquireTokenSilent({
                        scopes: ['User.ReadWrite.All', 'Directory.ReadWrite.All']
                    }).then(response => {
                        let accessToken = response.accessToken;

                        // Send the token to your Go server
                        fetch("/api/token", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ token: accessToken })
                        }).then(response => {
                            if (!response.ok) {
                                throw new Error(`Server error: ${response.statusText}`);
                            }
                            return response.text(); // Use text() instead of json() to inspect the raw response.
                        }).then(data => {
                            try {
                                const jsonData = JSON.parse(data);
                                console.log("Server response:", jsonData);
                                alert("Hello, " + jsonData.message + "!") ;
                                window.location.replace("http://localhost:8080/");
                            } catch (error) {
                                console.error("Failed to parse JSON:", error, "Raw response:", data);
                            }
                        }).catch(error => {
                            console.error("Failed to send token to server:", error);
                        });

                    }).catch(error => {
                        console.error("Failed to acquire access token:", error);
                    });
                }).catch(error => {
                    console.log("Error: " + error.message);
                });
        });
    </script>
</body>
</html>
